name: Tests automatisés

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        perl-version: ['5.20', '5.30', '5.32']

    steps:
    - uses: actions/checkout@v3

    - name: Setup Perl
      uses: shogo82148/actions-setup-perl@v1
      with:
        perl-version: ${{ matrix.perl-version }}

    - name: Install Pandoc
      run: |
        if [[ "$RUNNER_OS" == "Linux" ]]; then
          sudo apt-get update
          sudo apt-get install -y pandoc
        elif [[ "$RUNNER_OS" == "macOS" ]]; then
          brew install pandoc
        fi

    - name: Install Perl dependencies
      run: |
        cpanm --installdeps --notest .
        cpanm Pandoc JSON::PP

    - name: Check script syntax
      run: |
        perl -c bin/mdmc2docx.pl

    - name: Run tests
      run: |
        chmod +x tests/run_tests.sh
        make test

    - name: Test example conversion
      run: |
        make example
        # Vérifier que le fichier DOCX a été créé
        if [[ -f "examples/exemple_mc.docx" ]]; then
          echo "✅ Conversion exemple réussie"
        else
          echo "❌ Conversion exemple échouée"
          exit 1
        fi

  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Perl
      uses: shogo82148/actions-setup-perl@v1
      with:
        perl-version: '5.32'
        
    - name: Install Perl::Critic
      run: cpanm Perl::Critic
      
    - name: Perl Critic
      run: perlcritic bin/mdmc2docx.pl || true